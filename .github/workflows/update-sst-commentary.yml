name: Update SST Map Commentary

on:
  schedule:
    # æ¯é€±æœˆæ›œ UTC 00:00 (JST 09:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

jobs:
  update-commentary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic requests

      - name: Download NOAA image and generate commentary
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'PYTHON'
          import anthropic
          import base64
          import requests
          import json
          import os
          from datetime import datetime
          from pathlib import Path

          NOAA_IMAGE_URL = "https://www.ospo.noaa.gov/data/cb/ssta/ssta.daily.current.png"
          OUTPUT_PATH = Path("data/sst-map-commentary.json")
          MODEL = "claude-sonnet-4-20250514"

          PROMPT = """You are analyzing NOAA's daily SST anomaly map for a coral reef monitoring website (marine-obs.org).

          Target audience: Japanese divers and people interested in coral reef health.

          Analyze this image and provide:

          1. Extract the date shown in the image title (format: "8 Jan 2026")

          2. Brief commentary (2-3 sentences) covering:
             - ENSO pattern visible in the equatorial Pacific (El NiÃ±o/La NiÃ±a/Neutral)
             - Implications for western Pacific coral reefs, especially Japan/Okinawa region
             - Any notable marine heatwave areas that could affect coral health

          Guidelines:
          - Be informative but not alarmist
          - Focus on what divers and reef enthusiasts would find useful
          - Mention specific regions when relevant (Great Barrier Reef, Coral Triangle, Okinawa, etc.)

          Respond ONLY with valid JSON (no markdown, no code blocks):
          {
            "image_date": "8 Jan 2026",
            "en": "English commentary here...",
            "ja": "æ—¥æœ¬èªã®è§£èª¬ã‚’ã“ã“ã«..."
          }"""

          # Download image
          print(f"Downloading image from {NOAA_IMAGE_URL}")
          response = requests.get(NOAA_IMAGE_URL, timeout=30)
          response.raise_for_status()
          img_base64 = base64.standard_b64encode(response.content).decode("utf-8")

          # Call Claude API
          print(f"Calling Claude API ({MODEL})")
          client = anthropic.Anthropic()
          message = client.messages.create(
              model=MODEL,
              max_tokens=1024,
              messages=[{
                  "role": "user",
                  "content": [
                      {"type": "image", "source": {"type": "base64", "media_type": "image/png", "data": img_base64}},
                      {"type": "text", "text": PROMPT}
                  ],
              }],
          )

          response_text = message.content[0].text
          print(f"Raw response: {response_text[:200]}...")

          # Parse JSON
          cleaned = response_text.strip()
          if cleaned.startswith("```"):
              lines = cleaned.split("\n")
              cleaned = "\n".join(lines[1:-1])
          result = json.loads(cleaned)

          # Build output
          output = {
              "updated": datetime.now().strftime("%Y-%m-%d"),
              "image_date": result.get("image_date", ""),
              "commentary": {
                  "en": result.get("en", ""),
                  "ja": result.get("ja", "")
              }
          }

          # Write JSON
          OUTPUT_PATH.parent.mkdir(parents=True, exist_ok=True)
          with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
              json.dump(output, f, ensure_ascii=False, indent=2)

          print(f"âœ… Updated: {OUTPUT_PATH}")
          
          # Set outputs for notification
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"image_date={output['image_date']}\n")
              # Escape newlines for multiline
              ja_escaped = output['commentary']['ja'].replace('\n', ' ')
              f.write(f"commentary_ja={ja_escaped}\n")
          PYTHON

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/sst-map-commentary.json
          git diff --staged --quiet || git commit -m "Update SST map commentary [automated]"
          git push

      - name: Send Telegram notification (success)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="ğŸŒŠ *SST Map Commentary Updated*

          ğŸ“… Map date: ${{ steps.generate.outputs.image_date }}
          
          ${{ steps.generate.outputs.commentary_ja }}
          
          ğŸ”— [View on site](https://marine-obs.org/enso.html)"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview="true"

      - name: Send Telegram notification (failure)
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âŒ *SST Map Commentary Failed*
          
          Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
