/**
 * enso-chart.js - ONI (Oceanic Ni√±o Index) „ÉÅ„É£„Éº„Éà
 * 
 * „Éá„Éº„Çø„ÇΩ„Éº„Çπ: Supabase oni_monthly „ÉÜ„Éº„Éñ„É´
 * Ë°®Á§∫ÁØÑÂõ≤: 1980Âπ¥„ÄúÁèæÂú®
 */

(function() {
    const SUPABASE_URL = 'https://pegiuiblpliainpdggfj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZ2l1aWJscGxpYWlucGRnZ2ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMDkzNzQsImV4cCI6MjA3OTc4NTM3NH0.r9dBAsMLoXbgZL93lvA756r74U6YfCCfftHHlxYqZIw';

    // ÁôΩÂåñ„Ç§„Éô„É≥„ÉàÂπ¥Ôºà„Ç∞„É≠„Éº„Éê„É´„Åæ„Åü„ÅØÊó•Êú¨Ôºâ
    const bleachingYears = [1998, 2007, 2010, 2016, 2017, 2022, 2023, 2024];

    // SeasonÈ†ÜÂ∫èÔºà„Ç∞„É©„Éï„ÅÆXËª∏Áî®Ôºâ
    const seasonOrder = ['DJF', 'JFM', 'FMA', 'MAM', 'AMJ', 'MJJ', 'JJA', 'JAS', 'ASO', 'SON', 'OND', 'NDJ'];

    let chartInstance = null;

    async function fetchONIData() {
        try {
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/oni_monthly?year=gte.1980&select=year,season,anomaly&order=year.asc,id.asc`,
                {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Failed to fetch ONI data:', error);
            return null;
        }
    }

    function getONIColor(value) {
        if (value >= 0.5) return '#ef4444';  // El Ni√±o - red
        if (value <= -0.5) return '#3b82f6'; // La Ni√±a - blue
        return '#9ca3af';                     // Neutral - gray
    }

    function getENSOStatus(value) {
        const isJa = document.body.classList.contains('ja');
        if (value >= 2.0) return { text: isJa ? 'ÈùûÂ∏∏„Å´Âº∑„ÅÑEl Ni√±o' : 'Very Strong El Ni√±o', class: 'el-nino', icon: 'üî¥' };
        if (value >= 1.5) return { text: isJa ? 'Âº∑„ÅÑEl Ni√±o' : 'Strong El Ni√±o', class: 'el-nino', icon: 'üî¥' };
        if (value >= 1.0) return { text: isJa ? '‰∏≠Á®ãÂ∫¶El Ni√±o' : 'Moderate El Ni√±o', class: 'el-nino', icon: 'üü†' };
        if (value >= 0.5) return { text: isJa ? 'Âº±„ÅÑEl Ni√±o' : 'Weak El Ni√±o', class: 'el-nino', icon: 'üü°' };
        if (value <= -2.0) return { text: isJa ? 'ÈùûÂ∏∏„Å´Âº∑„ÅÑLa Ni√±a' : 'Very Strong La Ni√±a', class: 'la-nina', icon: 'üîµ' };
        if (value <= -1.5) return { text: isJa ? 'Âº∑„ÅÑLa Ni√±a' : 'Strong La Ni√±a', class: 'la-nina', icon: 'üîµ' };
        if (value <= -1.0) return { text: isJa ? '‰∏≠Á®ãÂ∫¶La Ni√±a' : 'Moderate La Ni√±a', class: 'la-nina', icon: 'üü¢' };
        if (value <= -0.5) return { text: isJa ? 'Âº±„ÅÑLa Ni√±a' : 'Weak La Ni√±a', class: 'la-nina', icon: 'üü¢' };
        return { text: isJa ? '‰∏≠Á´ã' : 'Neutral', class: 'neutral', icon: '‚ö™' };
    }

    function updateCurrentStatus(latestData) {
        const statusEl = document.getElementById('oni-current-status');
        if (!statusEl || !latestData) return;

        const status = getENSOStatus(latestData.anomaly);
        statusEl.className = `oni-status ${status.class}`;
        statusEl.innerHTML = `<strong>${latestData.season} ${latestData.year}</strong>: ${latestData.anomaly.toFixed(1)} (${status.text})`;
    }

    function updateHeroStatus(latestData) {
        const heroEl = document.getElementById('hero-enso-status');
        if (!heroEl || !latestData) return;

        const status = getENSOStatus(latestData.anomaly);
        const isJa = document.body.classList.contains('ja');
        
        const signedValue = latestData.anomaly >= 0 ? `+${latestData.anomaly.toFixed(1)}` : latestData.anomaly.toFixed(1);
        
        heroEl.innerHTML = `
            <div class="hero-enso-content ${status.class}">
                <span class="hero-enso-icon">${status.icon}</span>
                <span class="hero-enso-label">
                    ${isJa ? 'ÊúÄÊñ∞ONI' : 'Current ONI'}
                </span>
                <span class="hero-enso-value">${signedValue}¬∞C</span>
                <span class="hero-enso-period">${latestData.season} ${latestData.year}</span>
                <span class="hero-enso-status">${status.text}</span>
            </div>
        `;
    }

    function createChart(data) {
        const ctx = document.getElementById('oni-chart');
        if (!ctx) return;

        // Âπ¥Âçò‰Ωç„ÅßÈõÜÁ¥ÑÔºàÂêÑÂπ¥„ÅÆÊúÄÂ§ßÁµ∂ÂØæÂÄ§„ÇíÊé°Áî®Ôºâ
        const yearlyData = {};
        data.forEach(d => {
            if (!yearlyData[d.year] || Math.abs(d.anomaly) > Math.abs(yearlyData[d.year].anomaly)) {
                yearlyData[d.year] = d;
            }
        });

        const years = Object.keys(yearlyData).sort((a, b) => a - b);
        const values = years.map(y => yearlyData[y].anomaly);
        const colors = values.map(v => getONIColor(v));

        // ÁôΩÂåñ„Ç§„Éô„É≥„ÉàÂπ¥„ÅÆ„Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥
        const annotations = {};
        bleachingYears.forEach(year => {
            if (yearlyData[year]) {
                annotations[`bleaching${year}`] = {
                    type: 'point',
                    xValue: year.toString(),
                    yValue: yearlyData[year].anomaly,
                    backgroundColor: 'rgba(220, 38, 38, 0.8)',
                    borderColor: '#fff',
                    borderWidth: 2,
                    radius: 6,
                };
            }
        });

        // El Ni√±o / La Ni√±a ÈñæÂÄ§Á∑ö
        annotations.elNinoLine = {
            type: 'line',
            yMin: 0.5,
            yMax: 0.5,
            borderColor: 'rgba(239, 68, 68, 0.5)',
            borderWidth: 1,
            borderDash: [5, 5],
        };
        annotations.laNinaLine = {
            type: 'line',
            yMin: -0.5,
            yMax: -0.5,
            borderColor: 'rgba(59, 130, 246, 0.5)',
            borderWidth: 1,
            borderDash: [5, 5],
        };

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: years,
                datasets: [{
                    label: 'ONI',
                    data: values,
                    backgroundColor: colors,
                    borderRadius: 2,
                    barPercentage: 0.9,
                    categoryPercentage: 0.9,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const year = context[0].label;
                                const isBleaching = bleachingYears.includes(parseInt(year));
                                return isBleaching ? `${year} ‚ö†Ô∏è Bleaching Year` : year;
                            },
                            label: function(context) {
                                const value = context.parsed.y;
                                const status = getENSOStatus(value);
                                return `ONI: ${value.toFixed(1)} (${status.text})`;
                            }
                        }
                    },
                    annotation: {
                        annotations: annotations
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 15,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        min: -2.5,
                        max: 3,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            stepSize: 0.5,
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toFixed(1);
                            }
                        },
                        title: {
                            display: true,
                            text: 'ONI (¬∞C)',
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    }
                }
            }
        });
    }

    async function init() {
        const data = await fetchONIData();
        if (!data || data.length === 0) {
            const wrapper = document.querySelector('.oni-chart-wrapper');
            if (wrapper) {
                wrapper.innerHTML = '<div class="chart-loading">Failed to load ONI data</div>';
            }
            // Hero also shows error
            const heroEl = document.getElementById('hero-enso-status');
            if (heroEl) {
                heroEl.innerHTML = '<span class="hero-enso-error">Data unavailable</span>';
            }
            return;
        }

        // ÊúÄÊñ∞„Éá„Éº„Çø„Åß„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        const latestData = data[data.length - 1];
        updateCurrentStatus(latestData);
        updateHeroStatus(latestData);

        // „ÉÅ„É£„Éº„Éà‰ΩúÊàê
        createChart(data);
    }

    // Ë®ÄË™ûÂàáÊõøÊôÇ„Å´„Çπ„ÉÜ„Éº„Çø„ÇπÂÜçÊèèÁîª
    document.addEventListener('langChanged', async function() {
        const data = await fetchONIData();
        if (data && data.length > 0) {
            const latestData = data[data.length - 1];
            updateCurrentStatus(latestData);
            updateHeroStatus(latestData);
        }
    });

    // DOM Ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
